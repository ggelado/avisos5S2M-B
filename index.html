---
layout: default
title: "Avisos 5S2M-B"
---
<h1>Últimos avisos</h1>

<ul>
{% assign now = 'now' | date: "%s" %}
{% for post in site.posts %}
  {% assign post_expires = post.expires | date: "%s" %}
  {% if post_expires == nil or post_expires > now %}
    <li>
      <a href="{{ site.baseurl }}{{ post.url }}?utm_source=web&utm_medium=link&utm_campaign=avisos">{{ post.title }}</a>
({{ post.date | date: "%d %B %Y" }}{% if post.expires %} - Vigente hasta: {{ post.expires | date: "%d %B %Y"}}{% endif %})
    </li>
  {% endif %}
{% endfor %}
</ul>

<p>Recuerda que esta web se actualiza regularmente. Puedes suscribirte al <a href="{{ site.baseurl }}/feed.xml">feed RSS</a> para recibir las últimas noticias directamente en tu lector de RSS.</p>
<p style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; font-weight: bold; font-size: 1.1em;">
  Nuevo sistema de notificaciones push 
  <a href="https://notifierpushrss.onrender.com/" target="_blank" rel="noopener noreferrer" style="color: #0056b3; font-weight: bold;">Accede aquí</a>.
</p>


<p>Enlaces de utilidad:</p>
<a href="https://stats.uptimerobot.com/OuKYf98R4h" target="_blank" rel="noopener noreferrer">
  Estado de los principales servicios
</a>

<a href="https://crtm.es/comunicacion/actualidad-del-servicio/avisos/informacion-actualizada?lang=es" target="_blank" rel="noopener noreferrer">
  Estado del Transporte Público
</a>

<div style="
  max-width: 900px;
  margin: 20px auto;
  padding: 12px;
  background: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  font-family: sans-serif;
  font-size: 0.9em;
">

  <div style="
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: stretch;
  ">

    <!-- AEMET -->
    <div style="
      flex: 1 1 260px;
      min-width: 260px;
    ">
      <div style="
        margin-top: 6px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #ddd;
        height: 170px;
        background: white;
      ">
        <iframe
          title="El tiempo AEMET"
          src="https://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/boadilla-del-monte-id28022?w=g2p101010011ovmffffffx4f86d9t95b6e9r0s8n1"
          style="width:100%; height:100%; border:0;"
          scrolling="no"
          loading="lazy">
        </iframe>
      </div>
    </div>

    <!-- CRTM -->
    <div style="
		  flex: 1 1 260px;
		  min-width: 260px;
		">
		  <div style="
			margin-top: 6px;
			padding: 8px;
			background: white;
			border-radius: 8px;
			border: 1px solid #ddd;
			height: auto;
			overflow-x: auto;
			overflow-y: hidden;
		  ">
			<div id="estado-crtm" style="
			  white-space: nowrap;
			  overflow-x: auto;
			  text-align: center;
			">Cargando estado del servicio…</div>
		  </div>
		  
		  <!-- Próximos buses simplificado -->
		  <div id="buses-simplificado" style="
			margin-top: 8px;
			padding: 8px;
			background: white;
			border-radius: 8px;
			border: 1px solid #ddd;
			font-size: 0.85em;
			text-align: center;
		  ">
			Cargando próximos buses…
		  </div>
		</div>
    </div>

  </div>
</div>
<style>
/* Forzar que todo el contenido del CRTM quede en línea */
#estado-crtm * {
  display: inline-block !important;
  vertical-align: middle;
}

#estado-crtm img {
  max-height: 40px;
  width: auto;
  margin: 0 2px;
}

#estado-crtm .BarraVertical {
  width: 1px;
  height: 30px;
  background-color: #ccc;
  margin: 0 8px;
}

/* Asegurar que no haya saltos de línea */
#estado-crtm div {
  white-space: nowrap;
}
</style>



<p>>Si quieres publicar un aviso accede a <a href="https://notifierpushrss.onrender.com/avisos.html">https://notifierpushrss.onrender.com/avisos.html</a>. La web puede tardar unos segundos en cargar.</p>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<section class="container-lg my-4">

  <div id="status" class="text-small color-fg-muted mb-2">
  </div>

  <div class="Box">
    <div class="Box-body p-0">
      <ul id="arrivals" class="list-style-none m-0"></ul>
    </div>
  </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(() => {
  // --- Paradas de referencia por línea (para el endpoint locations) ---
  const LINE_STOPS = {
    "8__571___": "08771",
    "8__573___": "08771",
    "8__591___": "08411",
    "8__865___": "17573"
  };

  const SOURCES = [
  { url: "https://api.madridtransporte.com/stops/bus/08771/times", lines: ["571", "573"] },
  { url: "https://api.madridtransporte.com/stops/bus/08411/times", lines: ["591"] },
  { url: "https://api.madridtransporte.com/stops/bus/17573/times", lines: ["865"] },
  { 
    url: "https://api.madridtransporte.com/stops/tram/29/planned", 
    lines: null, 
    isTram: true // marca que es metro ligero
	}
  ];

  const arrivalsEl = document.getElementById("arrivals");
  const statusEl = document.getElementById("status");
  const maps = {}; // lineCode -> { map, markers }

  function minutesFromNow(ts) {
    return Math.max(0, Math.round((ts - Date.now()) / 60000));
  }

  function uniqueSorted(arr) {
    return [...new Set(arr)].sort((a, b) => a - b);
  }

  // --- Cargar próximas llegadas ---
  async function loadArrivals() {
    const results = [];

    for (const source of SOURCES) {
      try {
        const res = await fetch(source.url);
        const data = await res.json();

        // --- Metro Ligero ---
        if (source.isTram) {
          for (const arrival of data) {
            if (arrival.direction !== 2) continue; // solo dirección 2
            uniqueSorted(arrival.arrives || []).forEach(ts => {
              results.push({
                line: arrival.lineCode,
                lineCode: arrival.lineCode,
                destination: arrival.destination,
                minutes: minutesFromNow(ts),
                isTram: true
              });
            });
          }
          continue;
        }

        // --- Buses ---
        for (const arrival of data.arrives || []) {
          if (source.lines && !source.lines.includes(arrival.line)) continue;

          uniqueSorted(arrival.estimatedArrives || []).forEach(ts => {
            results.push({
              line: arrival.line,
              lineCode: arrival.lineCode,
              destination: arrival.destination,
              minutes: minutesFromNow(ts),
              isTram: false
            });
          });
        }
      } catch (e) {
        console.error("Error cargando", source.url, e);
      }
    }

    // Ordenar por tiempo
    const sorted = results.sort((a, b) => a.minutes - b.minutes);
    
    // Limitar metro ligero a 3 llegadas
    const tramArrivals = sorted.filter(a => a.isTram).slice(0, 3);
    const busArrivals = sorted.filter(a => !a.isTram);
    
    return [...busArrivals, ...tramArrivals].sort((a, b) => a.minutes - b.minutes);
  }

  // --- Cargar ubicación de buses con stopCode obligatorio ---
  async function loadBusLocations(lineCode) {
    const stopCode = LINE_STOPS[lineCode];
    if (!stopCode) return [];

    const url = `https://api.madridtransporte.com/lines/bus/${lineCode}/locations/2?stopCode=${stopCode}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      return data.locations || [];
    } catch (e) {
      console.error("Error cargando ubicación de buses", lineCode, e);
      return [];
    }
  }

  function createMap(container, locations) {
    const map = L.map(container).setView(
      [locations[0].coordinates.latitude, locations[0].coordinates.longitude],
      13
    );

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    return map;
  }

  function renderBuses(map, markers, locations) {
    markers.forEach(m => m.remove());
    markers.length = 0;

    locations.forEach(bus => {
      const m = L.marker([bus.coordinates.latitude, bus.coordinates.longitude])
        .addTo(map)
        .bindPopup(`
          <strong>Bus ${bus.codVehicle}</strong><br>
          Servicio: ${bus.service || "—"}
        `);
      markers.push(m);
    });

    if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.25));
    }
  }

  // --- Toggle mapa por línea ---
  async function toggleMap(btn) {
    const lineCode = btn.dataset.linecode;
    const container = document.getElementById(`map-${lineCode}`);

    if (container.classList.contains("d-none")) {
      container.classList.remove("d-none");
      btn.textContent = "Ocultar mapa";

      if (!maps[lineCode]) {
        const locations = await loadBusLocations(lineCode);
        if (!locations.length) {
          container.innerHTML = "<div class='p-3 text-small'>No hay buses en ruta</div>";
          return;
        }

        const map = createMap(container, locations);
        const markers = [];
        renderBuses(map, markers, locations);

        maps[lineCode] = { map, markers };
      }
    } else {
      container.classList.add("d-none");
      btn.textContent = "Ver ubicación (beta)";
    }
  }

  // --- Renderizar lista de llegadas ---
	function render(arrivals) {
	  arrivalsEl.innerHTML = "";

	  if (!arrivals.length) {
		arrivalsEl.innerHTML = "<li class='Box-row text-small color-fg-muted'>No hay servicios próximos</li>";
		return;
	  }

	  arrivals.forEach(a => {
		const li = document.createElement("li");
		li.className = "Box-row";

		li.innerHTML = `
		  <div class="d-flex flex-justify-between flex-items-center">
			<div>
			  <strong>${a.line}</strong>
			  <span class="color-fg-muted">→ ${a.destination}</span>
			</div>
			<div class="text-right">
			  <span class="Label Label--accent mr-2">${a.minutes} min</span>
			  ${a.isTram ? '' : `<button class="btn btn-sm btn-outline" data-linecode="${a.lineCode}">Ver ubicación (beta)</button>`}
			</div>
		  </div>
		  ${a.isTram ? '' : `<div id="map-${a.lineCode}" class="d-none mt-2" style="height: 300px; border-radius: 6px;"></div>`}
		`;

		arrivalsEl.appendChild(li);
	  });
	}

  arrivalsEl.addEventListener("click", e => {
    if (e.target.tagName === "BUTTON") {
      toggleMap(e.target);
    }
  });

  async function refresh() {
    statusEl.textContent = "Actualizando…";
    const arrivals = await loadArrivals();
    render(arrivals);
    statusEl.textContent = "Actualizado " + new Date().toLocaleTimeString() + ". Es la API del CRTM, no va muy bien, rogamos comprensión.";
  }

  refresh();
  setInterval(refresh, 60000);
})();
</script>
<script>
async function actualizarBusesSimplificados() {
  const contenedor = document.getElementById('buses-simplificado');
  if (!contenedor) return;

  const SOURCES = [
    { url: "https://api.madridtransporte.com/stops/bus/08771/times", lines: ["571", "573"] },
    { url: "https://api.madridtransporte.com/stops/bus/08411/times", lines: ["591"] },
    { url: "https://api.madridtransporte.com/stops/bus/17573/times", lines: ["865"] },
    { 
      url: "https://api.madridtransporte.com/stops/tram/29/planned", 
      lines: null, 
      isTram: true
    }
  ];

  function minutesFromNow(ts) {
    return Math.max(0, Math.round((ts - Date.now()) / 60000));
  }

  function uniqueSorted(arr) {
    return [...new Set(arr)].sort((a, b) => a - b);
  }

  try {
    const results = [];

    for (const source of SOURCES) {
      try {
        const res = await fetch(source.url);
        const data = await res.json();

        if (source.isTram) {
          for (const arrival of data) {
            if (arrival.direction !== 2) continue;
            uniqueSorted(arrival.arrives || []).forEach(ts => {
              results.push({
                line: arrival.lineCode,
                minutes: minutesFromNow(ts)
              });
            });
          }
          continue;
        }

        for (const arrival of data.arrives || []) {
          if (source.lines && !source.lines.includes(arrival.line)) continue;
          uniqueSorted(arrival.estimatedArrives || []).forEach(ts => {
            results.push({
              line: arrival.line,
              minutes: minutesFromNow(ts)
            });
          });
        }
      } catch (e) {
        console.error("Error cargando", source.url, e);
      }
    }

    const sorted = results.sort((a, b) => a.minutes - b.minutes);
    
    if (sorted.length === 0) {
      contenedor.innerHTML = 'No hay buses próximos';
      return;
    }

    const primerosLlegadas = sorted.slice(0, 5);
    const html = primerosLlegadas.map(a => 
      `<span><strong>${a.line}</strong>: <span class="bus-time">${a.minutes}'</span></span>`
    ).join(' · ');
    
    contenedor.innerHTML = html;
    
  } catch (err) {
    console.error('Error actualizando buses simplificados:', err);
    contenedor.innerHTML = 'Error al cargar';
  }
}

// Actualizar al cargar y cada minuto
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(actualizarBusesSimplificados, 1000);
  setInterval(actualizarBusesSimplificados, 60000);
});
</script>

<!-- Modal de descarga de la app -->
<div id="download-app-modal" style="
    display:none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
    z-index: 9999;
">
  <div style="
        background:white;
        width: 80%;
        max-width: 350px;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        text-align:center;
    ">

    <h3>Activa las notificaciones en tu navegador</h3>
    <p>Y podrás recibir avisos en cuanto se publiquen.</p>
    <p>La web puede tardar unos segundos en cargar.</p>
    <p>Recuerda pulsar "SUSCRIBIRME" y dar permiso a las notificaciones.</p>

    <!-- Botón universal -->
    <a id="universal-link" href="https://notifierpushrss.onrender.com/"
       style="margin: 15px 0; background:#4A90E2; color:white; padding:10px; border-radius:5px; text-decoration:none; display:block;">
       Activar notificaciones
    </a>

    <button id="close-modal" style="padding:8px 20px; border:none; background:#ccc; border-radius:5px;">
      Cerrar
    </button>
  </div>
</div>

{% raw %}
<script>
// Evitar mostrar el modal más de una vez
const shown = localStorage.getItem("appModalShown");

if (!shown) {
    document.getElementById("download-app-modal").style.display = "block";
}

// Cerrar el modal
document.getElementById("close-modal").onclick = function () {
    localStorage.setItem("appModalShown", "true");
    document.getElementById("download-app-modal").style.display = "none";
};
</script>
<script>
async function cargarEstadoCRTM() {
  const contenedor = document.getElementById("estado-crtm");
  if (!contenedor) return;

  const urlCRTM =
    "https://crtm.es/comunicacion/actualidad-del-servicio/avisos/informacion-actualizada?lang=es";

  const proxyURL =
    "https://corsproxy.io/?url=" + encodeURIComponent(urlCRTM);

  try {
    const response = await fetch(proxyURL);
    const html = await response.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const selector =
      "#colCentro > div > div.brdGris2 > div.cont > div:nth-child(2)";

    const divCRTM = doc.querySelector(selector);

    if (!divCRTM) {
      contenedor.innerText = "No se pudo obtener el estado del servicio";
      return;
    }

    // Clonamos para no mover nodos del documento remoto
    const clon = divCRTM.cloneNode(true);

    // Corregir rutas relativas de imágenes
    clon.querySelectorAll("img").forEach(img => {
      const src = img.getAttribute("src");
      if (src && src.trim().startsWith("/")) {
        img.src = "https://crtm.es" + src.trim();
      }
    });

    // Corregir rutas relativas de enlaces
    clon.querySelectorAll("a").forEach(a => {
      let href = a.getAttribute("href");
      if (!href) return;

      href = href.trim(); // elimina espacios y saltos de línea

      if (href.startsWith("/")) {
        a.href = "https://crtm.es" + href;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
      }
    });

    // Limpiar y agregar el contenido
    contenedor.innerHTML = "";
    contenedor.appendChild(clon);

  } catch (err) {
    console.error("Error CRTM:", err);
    contenedor.innerText = "Error al cargar información del servicio";
  }
}

// Cargar al iniciar
document.addEventListener("DOMContentLoaded", cargarEstadoCRTM);

// Auto-refresh cada 5 minutos
setInterval(cargarEstadoCRTM, 5 * 60 * 1000);
</script>



{% endraw %}







