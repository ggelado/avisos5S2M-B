---
layout: default
title: "Avisos 5S/6F 2M-B"
excerpt: "Aquí se publica información de relevancia de la Delegación del Grupo 6F2M-B del Grado en Ingeniería
Informática de la Escuela Técnica Superior de Ingenieros Informáticos de la Universidad Politécnica de Madrid."
---
<h1>Últimos avisos</h1>

<!-- MODO OSCURO TEMPORALMENTE DESHABILITADO
<div id="aviso-modo-oscuro" class="aviso-modo-oscuro" style="display: none;">
</div>
-->

<div class="avisos-container">
  {% assign now = 'now' | date: "%s" %}
  {% assign active_posts = 0 %}
  {% for post in site.posts %}
  {% assign post_expires = post.expires | date: "%s" %}
  {% if post_expires == nil or post_expires > now %}
  {% assign active_posts = active_posts | plus: 1 %}
  {% if post.last_modified_at %}
  {% assign modified_date = post.last_modified_at | date_to_xmlschema %}
  {% else %}
  {% assign modified_date = post.date | date_to_xmlschema %}
  {% endif %}
  <div data-post-url="{{ site.baseurl }}{{ post.url }}" data-date-modified="{{ modified_date }}" class="aviso-activo">
    <a href="{{ site.baseurl }}{{ post.url }}?utm_source=web&utm_medium=link&utm_campaign=avisos">{{ post.title }}</a>
    <span class="aviso-fecha">
      {{ post.date | date: "%d/%m/%Y" }}
      {% if post.expires %} · Caduca el {{ post.expires | date: "%d/%m/%Y a las %H:%M (%z)" }}{% endif %}
    </span>
  </div>
  {% endif %}
  {% endfor %}
  {% if active_posts == 0 %}
  <div class="sin-avisos">
    Sin avisos activos en este momento.
  </div>
  {% endif %}
  <div class="avisos-retirados">
    <a href="https://github.com/ggelado/avisos5S2M-B/tree/main/_posts" target="_blank" rel="noopener noreferrer">
      Avisos retirados (información posiblemente desactualizada)
    </a>
  </div>
</div>


{% if site.data.future_posts and site.data.future_posts.size > 0 %}
<details class="proximos-avisos">
  <summary>Próximos avisos</summary>

  <div class="proximos-lista">
    {% for post in site.data.future_posts %}
    <div class="futuro-aviso">
      <div class="futuro-aviso-titulo">{{ post.title }}</div>
      {% if post.excerpt %}
      <div class="futuro-aviso-excerpt">
        {{ post.excerpt | truncatewords: 20 }}
      </div>
      {% endif %}
      <span class="futuro-aviso-fecha">
        Se publicará el {{ post.date | date: "%d/%m/%Y" }}
        {% if post.expires %} · Caduca el {{ post.expires | date: "%d/%m/%Y" }}{% endif %}
      </span>
    </div>
    {% endfor %}
  </div>
</details>
{% endif %}

<p>Recuerda que esta web se actualiza regularmente. Puedes suscribirte al <a href="{{ site.baseurl }}/feed.xml">feed
    RSS</a> para recibir las últimas noticias directamente en tu lector de RSS. También puedes consultarlos desde <a
    href="https://calendar.google.com/calendar/r?cid=webcal%3A%2F%2Fggelado.github.io%2Favisos5S2M-B%2Favisos.ics">Google
    Calendar</a> o tu <a href="webcal://ggelado.github.io/avisos5S2M-B/avisos.ics"> calendario favorito</a>.</p>
<p class="notificacion-banner">
  Nuevo sistema de notificaciones push
  <a href="https://notifierpushrss.onrender.com/" target="_blank" rel="noopener noreferrer">Accede aquí</a>
</p>

<p>Enlaces de utilidad:</p>
<div class="enlaces-utilidad">
  <a href="https://stats.uptimerobot.com/OuKYf98R4h" target="_blank" rel="noopener noreferrer">
    Estado de los principales servicios
  </a>

  <a href="https://crtm.es/comunicacion/actualidad-del-servicio/avisos/informacion-actualizada?lang=es" target="_blank"
    rel="noopener noreferrer">
    Estado del Transporte Público
  </a>
</div>

<!-- BLOQUE WIDGETS -->
<div class="widgets-container">
  <div class="widgets-grid">
    <!-- AEMET -->
    <div class="widget">
      <div class="widget-contenido widget-aemet">
        <iframe title="El tiempo AEMET"
          src="https://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/boadilla-del-monte-id28022?w=g2p101010011ovmffffffx4f86d9t95b6e9r0s8n1"
          style="width:100%; height:100%; border:0;" scrolling="no" loading="lazy">
        </iframe>
      </div>
    </div>

    <!-- CRTM -->
    <div class="widget">
      <div class="widget-contenido widget-crtm">
        <div id="estado-crtm" style="text-align:center;">
          Cargando estado del servicio…
        </div>
      </div>

      <div class="widget-contenido widget-buses" id="buses-simplificado">
        Cargando próximos transportes…
      </div>
      <div class="widget-buses-label">
        <a href="/avisos5S2M-B/comoLlegar.html">
          ¿Y para ir?
        </a>
      </div>
    </div>
  </div>
</div>
<!-- FIN BLOQUE WIDGETS -->





<p>>Si quieres publicar un aviso accede <a href="/avisos5S2M-B/publicarAvisos.html">aquí</a>.</p>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  .widget-aemet {
    position: relative;
  }

  /* MODO OSCURO TEMPORALMENTE DESHABILITADO
@media (prefers-color-scheme: dark) {
  .widget-aemet::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    pointer-events: none;
    z-index: 1;
  }
}
*/

  /* Fix para los marcadores de Leaflet */
  .markdown-body .leaflet-marker-icon,
  .markdown-body .leaflet-marker-shadow {
    background-color: transparent !important;
  }


  /* MODO OSCURO TEMPORALMENTE DESHABILITADO
  .aviso-modo-oscuro {
    display: inline-block;
    margin: 4px 0 10px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.2px;
    color: #7c2d12;
    background: #ffedd5;
    border: 1px solid #fdba74;
  }
  */
</style>

<section class="container-lg my-4">

  <div id="status" class="text-small color-fg-muted mb-2">
  </div>

  <div id="aviso-atasco" class="text-small color-fg-muted mb-2" style="display: none;">
  </div>

  <div class="Box">
    <div class="Box-body p-0">
      <ul id="arrivals" class="list-style-none m-0"></ul>
    </div>
  </div>

  <div id="link-atascos" style="text-align:center; font-size:0.75em; margin-top:4px; display:none;">
  </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MODO OSCURO TEMPORALMENTE DESHABILITADO
<script>
  // Aviso condicional para modo oscuro
  document.addEventListener("DOMContentLoaded", () => {
    const aviso = document.getElementById("aviso-modo-oscuro");
    if (!aviso) return;

    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
      aviso.textContent = "Modo oscuro en beta. Podría haber errores o no cumplir contrastes WCAG.";
      aviso.style.display = "block";
    } else {
      aviso.style.display = "none";
    }
  });
</script>
-->

<script>
  async function mostrarLinkAtascos() {
    const contenedor = document.getElementById('link-atascos');
    if (!contenedor) return;

    try {
      const res = await fetch('https://notifierpushrss.onrender.com/api/poblados');
      if (!res.ok) throw new Error(`HTTP status ${res.status}`);
      const data = await res.json();

      if (data.hayAtascos) {
        // Mostrar enlace solo si hay atascos
        contenedor.innerHTML = `<a href="/avisos5S2M-B/poblados.html">
        Estado del tráfico en Av. Poblados
      </a>`;
        contenedor.style.display = 'block';
      } else {
        contenedor.style.display = 'none';
        contenedor.innerHTML = '';
      }

    } catch (err) {
      contenedor.style.display = 'none';
    }
  }

  // Ejecutar al cargar la página y refrescar cada 2 minutos
  document.addEventListener('DOMContentLoaded', () => {
    mostrarLinkAtascos();
    setInterval(mostrarLinkAtascos, 120000);
  });
</script>
<script>
  // --- Servicios lanzadera (horario fijo, L-V) ---
  const SHUTTLES = [
    {
      line: "LZ-CIU",
      destination: "Campus de Montegancedo → Ciudad Universitaria (PROGRAMADO. SOLO DÍAS LECTIVOS)",
      times: ["10:00", "11:00", "12:00", "13:00", "14:00"]
    },
    {
      line: "LZ-BARR",
      destination: "Campus de Montegancedo →  El Barrial – Centro Comercial Pozuelo (PROGRAMADO, SOLO DÍAS LECTIVOS)",
      times: ["08:35", "09:15", "10:00"]
    }
  ];

  (() => {
    // --- Paradas de referencia por línea (para el endpoint locations) ---
    const LINE_STOPS = {
      "8__571___": "08771",
      "8__573___": "08771",
      "8_N_905___": "08771",
      "8__591___": "08411",
      "8__865___": "17573"
    };

    const SOURCES = [
      { url: "https://api.madridtransporte.com/stops/bus/08771/times", lines: ["571", "573", "N905"] },
      { url: "https://api.madridtransporte.com/stops/bus/08411/times", lines: ["591"] },
      { url: "https://api.madridtransporte.com/stops/bus/17573/times", lines: ["865"] },
      {
        url: "https://api.madridtransporte.com/stops/tram/29/times",
        lines: null,
        isTram: true // marca que es metro ligero
      }
    ];

    const arrivalsEl = document.getElementById("arrivals");
    const statusEl = document.getElementById("status");
    const maps = {}; // lineCode -> { map, markers }

    function minutesFromNow(ts) {
      return Math.max(0, Math.round((ts - Date.now()) / 60000));
    }

    function isWeekday(date = new Date()) {
      const d = date.getDay();
      return d >= 1 && d <= 5; // L-V
    }


    function minutesUntilTodayTime(hhmm) {
      const [h, m] = hhmm.split(":").map(Number);
      const now = new Date();
      const t = new Date();
      t.setHours(h, m, 0, 0);
      return Math.round((t - now) / 60000);
    }


    function uniqueSorted(arr) {
      return [...new Set(arr)].sort((a, b) => a - b);
    }

    // --- Cargar próximas llegadas ---
    async function loadArrivals() {
      const results = [];

      for (const source of SOURCES) {
        try {
          const res = await fetch(source.url);
          const data = await res.json();

          // --- Metro Ligero ---
          if (source.isTram) {
            for (const arrival of data.arrives || []) {
              if (arrival.direction !== 2) continue;
              const times = uniqueSorted(arrival.estimatedArrives || []);
              times.forEach(ts => {
                results.push({
                  line: "ML3",
                  lineCode: arrival.lineCode,
                  destination: arrival.destination,
                  minutes: minutesFromNow(ts),
                  isTram: true
                });
              });
            }
            continue;
          }

          // --- Buses ---
          for (const arrival of data.arrives || []) {
            if (source.lines && !source.lines.includes(arrival.line)) continue;
            const times = uniqueSorted(arrival.estimatedArrives || []);
            times.forEach(ts => {
              results.push({
                line: arrival.line,
                lineCode: arrival.lineCode,
                destination: arrival.destination,
                minutes: minutesFromNow(ts),
                isTram: false
              });
            });
          }
        } catch (e) {
        }
      }

      // --- Lanzaderas programadas ---
      if (isWeekday()) {
        SHUTTLES.forEach(shuttle => {
          shuttle.times.forEach(time => {
            const minutes = minutesUntilTodayTime(time);

            // solo mostrar cuando quede menos de 1h
            if (minutes > 0 && minutes <= 60) {
              results.push({
                line: shuttle.line,
                lineCode: shuttle.line,
                destination: shuttle.destination,
                minutes,
                isShuttle: true
              });
            }
          });
        });
      }


      // Ordenar por tiempo
      const sorted = results.sort((a, b) => a.minutes - b.minutes);

      // Limitar metro ligero a 3 llegadas
      const tramArrivals = sorted
        .filter(a => a.isTram && a.line === "ML3")
        .slice(0, 3);

      // Buses normales
      const busArrivals = sorted.filter(a => !a.isTram && !a.isShuttle);

      // Lanzaderas
      const shuttleArrivals = sorted.filter(a => a.isShuttle);

      const final = [...busArrivals, ...shuttleArrivals, ...tramArrivals]
        .sort((a, b) => a.minutes - b.minutes);
      return final;

    }

    // --- Cargar ubicación de buses con stopCode obligatorio ---
    async function loadBusLocations(lineCode) {
      const stopCode = LINE_STOPS[lineCode];
      if (!stopCode) return [];

      const url = `https://api.madridtransporte.com/lines/bus/${lineCode}/locations/2?stopCode=${stopCode}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        return data.locations || [];
      } catch (e) {
        return [];
      }
    }

    function createMap(container, locations) {
      const map = L.map(container).setView(
        [locations[0].coordinates.latitude, locations[0].coordinates.longitude],
        13
      );

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap"
      }).addTo(map);

      return map;
    }

    function renderBuses(map, markers, locations) {
      markers.forEach(m => m.remove());
      markers.length = 0;

      locations.forEach(bus => {
        const m = L.marker([bus.coordinates.latitude, bus.coordinates.longitude])
          .addTo(map)
          .bindPopup(`
          <strong>Bus ${bus.codVehicle}</strong><br>
          Servicio: ${bus.service || "—"}
        `);
        markers.push(m);
      });

      if (markers.length) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.25));
      }
    }

    // --- Toggle mapa por línea ---
    async function toggleMap(btn) {
      const lineCode = btn.dataset.linecode;
      const container = document.getElementById(`map-${lineCode}`);

      if (container.classList.contains("d-none")) {
        container.classList.remove("d-none");
        btn.textContent = "Ocultar mapa";

        if (!maps[lineCode]) {
          const locations = await loadBusLocations(lineCode);
          if (!locations.length) {
            container.innerHTML = "<div class='p-3 text-small'>No hay buses en ruta</div>";
            return;
          }

          const map = createMap(container, locations);
          const markers = [];
          renderBuses(map, markers, locations);

          maps[lineCode] = { map, markers };
        }
      } else {
        container.classList.add("d-none");
        btn.textContent = "Ver ubicación (beta)";
      }
    }

    // --- Renderizar lista de llegadas ---
    function render(arrivals) {
      arrivalsEl.innerHTML = "";

      if (!arrivals.length) {
        arrivalsEl.innerHTML = "<li class='Box-row text-small color-fg-muted'>No hay servicios próximos</li>";
        return;
      }

      arrivals.forEach((a, idx) => {
        const li = document.createElement("li");
        li.className = "Box-row";

        li.innerHTML = `
		  <div class="d-flex flex-justify-between flex-items-center">
			<div>
			  <strong>${a.line}</strong>
			  <span class="color-fg-muted">→ ${a.destination}</span>
			</div>
			<div class="text-right">
			  <span class="Label Label--accent mr-2">${a.minutes} min</span>
			  ${(a.isTram || a.isShuttle) ? '' : `<button class="btn btn-sm btn-outline" data-linecode="${a.lineCode}">Ver ubicación (beta)</button>`}
			</div>
		  </div>
		  ${(a.isTram || a.isShuttle) ? '' : `<div id="map-${a.lineCode}" class="d-none mt-2" style="height: 300px; border-radius: 6px;"></div>`}
		`;

        arrivalsEl.appendChild(li);
      });
    }

    arrivalsEl.addEventListener("click", e => {
      if (e.target.tagName === "BUTTON") {
        toggleMap(e.target);
      }
    });

    async function refresh() {
      statusEl.textContent = "Actualizando…";
      const arrivals = await loadArrivals();
      render(arrivals);
      statusEl.textContent = "Actualizado " + new Date().toLocaleTimeString() + ". Es la API del CRTM, no va muy bien, rogamos comprensión. Las líneas no mostradas son por no recibir respuesta en la API.";
    }

    refresh();
    setInterval(refresh, 60000);
  })();
</script>
<script>
  async function verificarAtasco() {
    const avisoEl = document.getElementById('aviso-atasco');
    if (!avisoEl) return;

    try {
      const res = await fetch('https://notifierpushrss.onrender.com/api/m511');
      const data = await res.json();

      if (data.total_atascos === 0) {
        avisoEl.style.display = 'none';
        return;
      }

      // Prioridad de gravedad
      const prioridad = {
        'lowest': 1,
        'low': 2,
        'medium': 3,
        'high': 4,
        'highest': 5
      };

      // Buscar el atasco más grave
      const atasco = data.atascos.reduce((max, actual) => {
        return (prioridad[actual.gravedad] || 0) >
          (prioridad[max.gravedad] || 0)
          ? actual
          : max;
      }, data.atascos[0]);

      const nivelTexto = {
        'lowest': 'muy leve',
        'low': 'leve',
        'medium': 'medio',
        'high': 'grave',
        'highest': 'muy grave'
      }[atasco.gravedad] || atasco.nivel_gravedad;

      avisoEl.textContent = `Hay atasco ${nivelTexto} en Colonia Jardín.`;
      avisoEl.style.display = 'block';

    } catch (err) {
      avisoEl.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    verificarAtasco();
    setInterval(verificarAtasco, 120000);
  });
</script>

<script>
  async function actualizarBusesSimplificados() {
    const contenedor = document.getElementById('buses-simplificado');
    if (!contenedor) return;

    const SOURCES = [
      { url: "https://api.madridtransporte.com/stops/bus/08771/times", lines: ["571", "573", "N905"] },
      { url: "https://api.madridtransporte.com/stops/bus/08411/times", lines: ["591"] },
      { url: "https://api.madridtransporte.com/stops/bus/17573/times", lines: ["865"] },
      {
        url: "https://api.madridtransporte.com/stops/tram/29/times",
        lines: null,
        isTram: true
      }
    ];

    function minutesFromNow(ts) {
      return Math.max(0, Math.round((ts - Date.now()) / 60000));
    }

    function isWeekday(date = new Date()) {
      const d = date.getDay();
      return d >= 1 && d <= 5; // L-V
    }


    function minutesUntilTodayTime(hhmm) {
      const [h, m] = hhmm.split(":").map(Number);
      const now = new Date();
      const t = new Date();
      t.setHours(h, m, 0, 0);
      return Math.round((t - now) / 60000);
    }

    function uniqueSorted(arr) {
      return [...new Set(arr)].sort((a, b) => a - b);
    }

    try {
      const results = [];

      for (const source of SOURCES) {
        try {
          const res = await fetch(source.url);
          const data = await res.json();

          if (source.isTram) {
            for (const arrival of data.arrives || []) {
              if (arrival.direction !== 2) continue;
              const times = uniqueSorted(arrival.estimatedArrives || []);
              times.forEach(ts => {
                results.push({
                  line: "ML3",
                  minutes: minutesFromNow(ts)
                });
              });
            }
            continue;
          }

          for (const arrival of data.arrives || []) {
            if (source.lines && !source.lines.includes(arrival.line)) continue;
            const times = uniqueSorted(arrival.estimatedArrives || []);
            times.forEach(ts => {
              results.push({
                line: arrival.line,
                minutes: minutesFromNow(ts)
              });
            });
          }

        } catch (e) {
        }
      }

      if (isWeekday()) {
        SHUTTLES.forEach(shuttle => {
          shuttle.times.forEach(time => {
            const minutes = minutesUntilTodayTime(time);

            // solo mostrar cuando quede menos de 1h
            if (minutes > 0 && minutes <= 60) {
              results.push({
                line: shuttle.line,
                lineCode: shuttle.line,
                destination: shuttle.destination,
                minutes,
                isTram: true
              });
            }
          });
        });
      }

      const sorted = results.sort((a, b) => a.minutes - b.minutes);

      if (sorted.length === 0) {
        contenedor.innerHTML = 'No hay buses próximos';
        return;
      }

      const primerosLlegadas = sorted.slice(0, 5);
      const html = primerosLlegadas.map(a =>
        `<span><strong>${a.line}</strong>: <span class="bus-time">${a.minutes}'</span></span>`
      ).join(' · ');

      contenedor.innerHTML = html;

    } catch (err) {
      contenedor.innerHTML = 'API CRTM caída. Actualiza la web.';
    }
  }

  // Actualizar al cargar y cada minuto
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(actualizarBusesSimplificados, 1000);
    setInterval(actualizarBusesSimplificados, 60000);
  });
</script>

<!-- Modal de descarga de la app -->
<div id="download-app-modal" class="download-app-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
  <div class="download-app-modal__dialog">

    <p id="modal-title" class="download-app-modal__title">Activa las notificaciones en tu navegador</p>
    <p>Y podrás recibir avisos en cuanto se publiquen.</p>
    <p>La web puede tardar unos segundos en cargar.</p>
    <p>Recuerda pulsar "SUSCRIBIRME" y dar permiso a las notificaciones.</p>

    <!-- Botón universal -->
    <a id="universal-link" class="download-app-modal__primary" href="https://notifierpushrss.onrender.com/">
      Activar notificaciones
    </a>

    <button id="close-modal" class="download-app-modal__close">
      Cerrar
    </button>
  </div>
</div>

<script>
  // Evitar mostrar el modal más de una vez
  const shown = localStorage.getItem("appModalShown");

  if (!shown) {
    document.getElementById("download-app-modal").style.display = "block";
  }

  // Cerrar el modal
  document.getElementById("close-modal").onclick = function () {
    localStorage.setItem("appModalShown", "true");
    document.getElementById("download-app-modal").style.display = "none";
  };
</script>
{% include logica_crtm.html %}

<!-- Resaltado de avisos no visualizados -->
<script>
  (() => {
    const items = document.querySelectorAll("[data-post-url]");
    items.forEach(div => {
      const url = div.dataset.postUrl;
      const dateModified = div.dataset.dateModified;
      const link = div.querySelector("a");
      if (!link) return;

      if (isPostModifiedSinceLastVisit(url, dateModified)) {
        // No leído → naranja (ya viene del estilo inline, no hace falta tocarlo)
        const star = document.createElement("span");
        star.textContent = "★ ";
        star.style.color = "#f59e0b";
        link.prepend(star);
      } else {
        // Leído → azul/purple
        div.classList.add('aviso-visto');
      }
    });
  })();
</script>






