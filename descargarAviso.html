---
layout: default
title: Avisos de Tráfico M-40
sitemap: false
---

<div id="traffic-viewer">
  
  <div id="loading">Cargando avisos...</div>
  <div id="error" style="display: none; color: red;"></div>
  
  <div id="avisos-container"></div>
</div>

<p>¿Quieres certificarlo? Utiliza un prestador cualificado y pídele que ejecute un sello de tiempo a <code>https://nap.dgt.es/datex2/v3/dgt/SituationPublication/datex2_v36.xml</code>.</p>
<p>También puedes ejecutar este comando en tu terminal linux preferida:</p>
<pre><code class="fenced-code-block language-bash">curl 'https://freetsa.org/screenshot.php' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-raw 'delay=n&amp;screenshot=https%3A%2F%2Fnap.dgt.es%2Fdatex2%2Fv3%2Fdgt%2FSituationPublication%2Fdatex2_v36.xml' &gt; fich.pdf</code></pre>
<p>Nota: Prestador <strong>NO CUALIFICADO eIDAS</strong>.</p>


<style>
  .aviso-card {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f9f9f9;
  }
  
  .aviso-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .aviso-id {
    font-weight: bold;
    color: #333;
  }
  
  .aviso-time {
    font-size: 0.9em;
    color: #666;
  }
  
  .aviso-details {
    margin: 10px 0;
  }
  
  .aviso-location {
    color: #555;
    margin: 5px 0;
  }
  
  .download-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  
  .download-btn:hover {
    background-color: #0056b3;
  }
  
  .download-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .situacion-group {
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f0f0f0;
    border-left: 4px solid #007bff;
  }

  .situacion-header {
    font-weight: bold;
    margin-bottom: 10px;
    color: #007bff;
  }
</style>

<script>
  const API_BASE = 'https://notifierpushrss.onrender.com';
  
  async function cargarAvisos() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('avisos-container');
    
    try {
      const response = await fetch(`${API_BASE}/api/m40detalle`);
      
      if (!response.ok) {
        throw new Error('Error al cargar los avisos');
      }
      
      const data = await response.json();
      loading.style.display = 'none';
      
      if (!data.situaciones || data.situaciones.length === 0) {
        container.innerHTML = '<p>No hay avisos activos en este momento.</p>';
        return;
      }
      
      // Contar total de registros
      const totalRegistros = data.situaciones.reduce((sum, sit) => sum + sit.registros.length, 0);
      
      let html = `<p><strong>Total de incidencias activas: ${totalRegistros}</strong></p>`;
      
      // Iterar por cada situación y sus registros
      data.situaciones.forEach(situacion => {
        // Si hay múltiples registros en una situación, mostrar el agrupamiento
        if (situacion.registros.length > 1) {
          html += `
            <div class="situacion-group">
              <div class="situacion-header">Situación #${situacion.id} (${situacion.registros.length} registros)</div>
          `;
        }
        
        // Mostrar cada registro individualmente
        situacion.registros.forEach(registro => {
          const fecha = new Date(registro.tiempos.creacion || registro.tiempos.actualizacion);
          
          // Determinar la estructura de ubicación
          let ubicacionTexto, coordenadas;
          
          if (registro.ubicacion.tipo === 'loc:PointLocation') {
            const ubicacion = registro.ubicacion.punto;
            ubicacionTexto = `${registro.ubicacion.info_carretera.nombre} KM ${ubicacion.kilometro} - ${ubicacion.municipio}, ${ubicacion.provincia}`;
            coordenadas = ubicacion.coordenadas;
          } else if (registro.ubicacion.tipo === 'loc:SingleRoadLinearLocation') {
            const tramo = registro.ubicacion.tramo;
            ubicacionTexto = `${registro.ubicacion.info_carretera.nombre} del KM ${tramo.km_inicio} al KM ${tramo.km_fin} - ${tramo.desde.municipio}, ${tramo.desde.provincia}`;
            coordenadas = tramo.desde.coordenadas;
          }
          
          // Obtener dirección
          const direccion = registro.ubicacion.punto?.direccion_tpeg || 
                           registro.ubicacion.tramo?.direccion_tpeg || 
                           'No especificado';
          
          html += `
            <div class="aviso-card">
              <div class="aviso-header">
                <span class="aviso-id">Registro #${registro.registro_id} (Situación #${situacion.id})</span>
                <span class="aviso-time">${fecha.toLocaleString('es-ES')}</span>
              </div>
              
              <div class="aviso-details">
                <p><strong>Tipo:</strong> ${obtenerDescripcionCausa(registro)}</p>
                <p class="aviso-location">
                  <strong>Ubicación:</strong> ${ubicacionTexto}
                </p>
                <p><strong>Sentido:</strong> ${obtenerDireccion(direccion)}</p>
                ${registro.severidad ? `<p><strong>Severidad:</strong> ${registro.severidad}</p>` : ''}
              </div>
              
              <button 
                class="download-btn" 
                onclick="descargarPDF('${registro.registro_id}')"
              >
                Descargar aviso de este registro
              </button>
            </div>
          `;
        });
        
        if (situacion.registros.length > 1) {
          html += `</div>`;
        }
      });
      
      container.innerHTML = html;
      
    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error al cargar los avisos: ' + err.message;
    }
  }
  
  function obtenerDescripcionCausa(registro) {
    if (registro.tipo === 'AbnormalTraffic') {
      const descripciones = {
        'slowTraffic': 'Tráfico lento',
        'queueingTraffic': 'Tráfico con colas',
        'stationaryTraffic': 'Tráfico detenido'
      };
      return descripciones[registro.trafico_anormal?.tipo] || 'Tráfico anormal';
    }
    
    if (registro.causa?.detalle?.tipo_obstruccion_vehiculo) {
      const descripciones = {
        'vehicleStuck': 'Vehículo averiado',
        'brokenDownVehicle': 'Vehículo averiado',
        'vehicleOnFire': 'Vehículo en llamas'
      };
      return descripciones[registro.causa.detalle.tipo_obstruccion_vehiculo] || 'Obstrucción vehicular';
    }
    
    if (registro.causa?.tipo) {
      const descripciones = {
        'accident': 'Accidente',
        'abnormalTraffic': 'Tráfico anormal',
        'obstructionOnTheRoad': 'Obstrucción en la vía'
      };
      return descripciones[registro.causa.tipo] || registro.causa.tipo;
    }
    
    return registro.tipo || 'Incidencia de tráfico';
  }
  
  function obtenerDireccion(direccion) {
    const direcciones = {
      'southWestBound': 'Suroeste',
      'westBound': 'Oeste',
      'northWestBound': 'Noroeste',
      'northBound': 'Norte',
      'eastBound': 'Este',
      'southBound': 'Sur',
      'southEastBound': 'Sureste',
      'northEastBound': 'Noreste'
    };
    return direcciones[direccion] || direccion;
  }
  
  async function descargarPDF(registroId) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Descargando...';
    
    try {
      const response = await fetch(`${API_BASE}/api/pdf/${registroId}`);
      
      if (!response.ok) {
        throw new Error('Error al descargar el PDF');
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `aviso-trafico-${registroId}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      btn.disabled = false;
      btn.textContent = 'Descargar aviso de este registro';
    } catch (err) {
      alert('Error al descargar el PDF: ' + err.message);
      btn.disabled = false;
      btn.textContent = 'Descargar aviso de este registro';
    }
  }
  
  // Cargar avisos al cargar la página
  document.addEventListener('DOMContentLoaded', cargarAvisos);
  
  // Recargar cada 2 minutos
  setInterval(cargarAvisos, 120000);
</script>