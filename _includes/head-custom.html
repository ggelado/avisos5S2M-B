<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HP1VJBHQL3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HP1VJBHQL3');
</script>

<!-- Selector de tema claro/oscuro -->
<script>
(function() {
  const THEME_KEY = 'theme';
  const THEME_DARK = 'dark';

  function isDarkModeActive() {
    return localStorage.getItem(THEME_KEY) === THEME_DARK;
  }

  function applyDarkTheme() {
    const darkCustom = document.createElement('link');
    darkCustom.rel = 'stylesheet';
    darkCustom.href = '{{ site.baseurl }}/assets/css/custom_dark.css';
    document.head.appendChild(darkCustom);

    const darkCallouts = document.createElement('link');
    darkCallouts.rel = 'stylesheet';
    darkCallouts.href = '{{ site.baseurl }}/assets/css/callouts_dark.css';
    document.head.appendChild(darkCallouts);

    document.documentElement.setAttribute('data-theme', 'dark');
  }

  if (isDarkModeActive()) {
    applyDarkTheme();
  }

  document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('theme-toggle');
    if (!toggle) return;

    function updateToggleLabel() {
      const isDark = isDarkModeActive();
      const label = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
      toggle.setAttribute('aria-pressed', String(isDark));
      toggle.setAttribute('aria-label', label);
      toggle.setAttribute('title', label);
    }

    toggle.addEventListener('click', function() {
      const isDark = isDarkModeActive();
      localStorage.setItem(THEME_KEY, isDark ? 'light' : THEME_DARK);
      window.location.reload();
    });

    updateToggleLabel();
  });
})();
</script>

<!-- Para facilitar añadir a pantalla inicio en móviles -->
<link rel="manifest" href="{{ site.baseurl }}/manifest.json">
<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Avisos 5S2M-B">
<link rel="icon" href="/avisos5S2M-B/favicon.ico" type="image/x-icon">

<!-- Icono iOS -->
<link rel="apple-touch-icon" href="/avisos5S2M-B/icons/180.png">

<!-- Páginas no vistas (para resaltados) -->
<script>
const SEEN_KEY = "seenPosts";

// Recupera los posts vistos (ahora con timestamp de última visita)
function getSeenPosts() {
  try {
    const data = localStorage.getItem(SEEN_KEY);
    if (!data) return {};
    
    const parsed = JSON.parse(data);
    
    // Migración automática: si es un array (formato antiguo), convertir a objeto
    if (Array.isArray(parsed)) {
      const migrated = {};
      parsed.forEach(url => {
        migrated[url] = new Date().toISOString();
      });
      saveSeenPosts(migrated);
      return migrated;
    }
    
    return parsed;
  } catch {
    return {};
  }
}

// Guarda el objeto actualizado { url: timestamp }
function saveSeenPosts(obj) {
  localStorage.setItem(SEEN_KEY, JSON.stringify(obj));
}

// Marca un post como visto con la fecha actual
function markPostAsSeen(url) {
  const seen = getSeenPosts();
  seen[url] = new Date().toISOString();
  saveSeenPosts(seen);
}

// Verifica si un post ha sido modificado desde la última visita
function isPostModifiedSinceLastVisit(url, dateModified) {
  const seen = getSeenPosts();
  const lastVisit = seen[url];
  
  if (!lastVisit) return true; // nunca visto = considerarlo "nuevo"
  if (!dateModified) return false; // sin fecha de modificación = no modificado
  
  try {
    const lastVisitDate = new Date(lastVisit);
    const modifiedDate = new Date(dateModified);
    return modifiedDate > lastVisitDate;
  } catch {
    return false;
  }
}

// Limpia los posts que ya no existen en el sitio
function cleanupDeletedPosts(existingPostUrls) {
  const seen = getSeenPosts();
  const existingSet = new Set(existingPostUrls);
  let hasChanges = false;
  
  for (const url in seen) {
    if (!existingSet.has(url)) {
      delete seen[url];
      hasChanges = true;
    }
  }
  
  if (hasChanges) {
    saveSeenPosts(seen);
  }
}

// Inicialización (ejecutar migración si es necesario)
(function initializeSeenPosts() {
  getSeenPosts(); // esto ejecuta la migración automática si es necesario
})();
</script>