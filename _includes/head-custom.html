<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HP1VJBHQL3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HP1VJBHQL3');
</script>
<!-- Para facilitar añadir a pantalla inicio en móviles -->
<link rel="manifest" href="{{ site.baseurl }}/manifest.json">
<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Avisos 5S2M-B">
<link rel="icon" href="/avisos5S2M-B/favicon.ico" type="image/x-icon">

<!-- Icono iOS -->
<link rel="apple-touch-icon" href="/avisos5S2M-B/icons/180.png">

<!-- Páginas no vistas (para resaltados) -->
<script>
const SEEN_KEY = "seenPosts";

// Recupera los posts vistos (ahora con timestamp de última visita)
function getSeenPosts() {
  try {
    const data = localStorage.getItem(SEEN_KEY);
    if (!data) return {};
    
    const parsed = JSON.parse(data);
    
    // Migración automática: si es un array (formato antiguo), convertir a objeto
    if (Array.isArray(parsed)) {
      const migrated = {};
      parsed.forEach(url => {
        migrated[url] = new Date().toISOString();
      });
      saveSeenPosts(migrated);
      return migrated;
    }
    
    return parsed;
  } catch {
    return {};
  }
}

// Guarda el objeto actualizado { url: timestamp }
function saveSeenPosts(obj) {
  localStorage.setItem(SEEN_KEY, JSON.stringify(obj));
}

// Marca un post como visto con la fecha actual
function markPostAsSeen(url) {
  const seen = getSeenPosts();
  seen[url] = new Date().toISOString();
  saveSeenPosts(seen);
}

// Verifica si un post ha sido modificado desde la última visita
function isPostModifiedSinceLastVisit(url, dateModified) {
  const seen = getSeenPosts();
  const lastVisit = seen[url];
  
  if (!lastVisit) return true; // nunca visto = considerarlo "nuevo"
  if (!dateModified) return false; // sin fecha de modificación = no modificado
  
  try {
    const lastVisitDate = new Date(lastVisit);
    const modifiedDate = new Date(dateModified);
    return modifiedDate > lastVisitDate;
  } catch {
    return false;
  }
}

// Inicialización (ejecutar migración si es necesario)
(function initializeSeenPosts() {
  getSeenPosts(); // esto ejecuta la migración automática si es necesario
})();
</script>

<div id="banner-trafico-anormal" class="top-banner" style="display:none;">
  <span id="banner-trafico-anormal-texto"></span>
  <button onclick="document.getElementById('banner-trafico-anormal').style.display='none'">✕</button>
</div>

<script>
(async function () {
  const ENDPOINT = "https://notifierpushrss.onrender.com/api/m40";
  const banner = document.getElementById("banner-trafico-anormal");
  const texto = document.getElementById("banner-trafico-anormal-texto");

  try {
    const res = await fetch(ENDPOINT);
    if (!res.ok) return;

    const data = await res.json();

    if (
      data &&
      data.trafico_anormal &&
      data.trafico_anormal.total > 0 &&
      Array.isArray(data.trafico_anormal.registros)
    ) {
      const tramos = data.trafico_anormal.registros.map(r => {
        return `km ${r.km_inicio}-${r.km_fin} (${r.sentido}, tráfico ${r.tipo_trafico})`;
      });

      texto.textContent =
        `Atasco grave en ${data.carretera}: ` + tramos.join(" · ");

      banner.style.display = "block";
    }
  } catch (e) {
    // Silencioso: si falla o tarda mucho no mostramos nada
  }
})();
</script>
