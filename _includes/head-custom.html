<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HP1VJBHQL3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HP1VJBHQL3');
</script>

<!-- Sistema de detecci贸n de Modo Oscuro Beta -->
<script>
(function() {
  const DARK_MODE_KEY = 'darkModeBeta';
  
  function isDarkModeActive() {
    return localStorage.getItem(DARK_MODE_KEY) === 'true';
  }
  
  // Si el usuario est谩 en beta, cargar CSS oscuros inmediatamente
  if (isDarkModeActive()) {
    // Cargar custom_dark.css
    const darkCustom = document.createElement('link');
    darkCustom.rel = 'stylesheet';
    darkCustom.href = '{{ site.baseurl }}/assets/css/custom_dark.css';
    document.head.appendChild(darkCustom);
    
    // Cargar callouts_dark.css
    const darkCallouts = document.createElement('link');
    darkCallouts.rel = 'stylesheet';
    darkCallouts.href = '{{ site.baseurl }}/assets/css/callouts_dark.css';
    document.head.appendChild(darkCallouts);
    
    // A帽adir clase al body para identificaci贸n
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('dark-mode-beta');
      
      // Mostrar indicador beta (opcional)
      const indicator = document.createElement('div');
      indicator.className = 'beta-indicator';
      indicator.textContent = ' Beta';
      document.body.appendChild(indicator);
    });
  }
})();
</script>

<!-- Para facilitar a帽adir a pantalla inicio en m贸viles -->
<link rel="manifest" href="{{ site.baseurl }}/manifest.json">
<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Avisos 5S2M-B">
<link rel="icon" href="/avisos5S2M-B/favicon.ico" type="image/x-icon">

<!-- Icono iOS -->
<link rel="apple-touch-icon" href="/avisos5S2M-B/icons/180.png">

<!-- P谩ginas no vistas (para resaltados) -->
<script>
const SEEN_KEY = "seenPosts";

// Recupera los posts vistos (ahora con timestamp de 煤ltima visita)
function getSeenPosts() {
  try {
    const data = localStorage.getItem(SEEN_KEY);
    if (!data) return {};
    
    const parsed = JSON.parse(data);
    
    // Migraci贸n autom谩tica: si es un array (formato antiguo), convertir a objeto
    if (Array.isArray(parsed)) {
      const migrated = {};
      parsed.forEach(url => {
        migrated[url] = new Date().toISOString();
      });
      saveSeenPosts(migrated);
      return migrated;
    }
    
    return parsed;
  } catch {
    return {};
  }
}

// Guarda el objeto actualizado { url: timestamp }
function saveSeenPosts(obj) {
  localStorage.setItem(SEEN_KEY, JSON.stringify(obj));
}

// Marca un post como visto con la fecha actual
function markPostAsSeen(url) {
  const seen = getSeenPosts();
  seen[url] = new Date().toISOString();
  saveSeenPosts(seen);
}

// Verifica si un post ha sido modificado desde la 煤ltima visita
function isPostModifiedSinceLastVisit(url, dateModified) {
  const seen = getSeenPosts();
  const lastVisit = seen[url];
  
  if (!lastVisit) return true; // nunca visto = considerarlo "nuevo"
  if (!dateModified) return false; // sin fecha de modificaci贸n = no modificado
  
  try {
    const lastVisitDate = new Date(lastVisit);
    const modifiedDate = new Date(dateModified);
    return modifiedDate > lastVisitDate;
  } catch {
    return false;
  }
}

// Limpia los posts que ya no existen en el sitio
function cleanupDeletedPosts(existingPostUrls) {
  const seen = getSeenPosts();
  const existingSet = new Set(existingPostUrls);
  let hasChanges = false;
  
  for (const url in seen) {
    if (!existingSet.has(url)) {
      delete seen[url];
      hasChanges = true;
    }
  }
  
  if (hasChanges) {
    saveSeenPosts(seen);
  }
}

// Inicializaci贸n (ejecutar migraci贸n si es necesario)
(function initializeSeenPosts() {
  getSeenPosts(); // esto ejecuta la migraci贸n autom谩tica si es necesario
})();
</script>