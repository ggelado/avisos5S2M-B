<div id="alertas-container"></div>
<script>

  const RSS_MADRID = "https://www.aemet.es/documentos_d/eltiempo/prediccion/avisos/rss/CAP_AFAC72_RSS.xml";
  const CORS_PROXY = "https://cors.eu.org/";

  async function descargar(url) {
    try {
      const proxiedUrl = CORS_PROXY + encodeURIComponent(url);
      const response = await fetch(proxiedUrl);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.text();
    } catch (error) {
      console.error(`Error al descargar ${url}:`, error);
      return null;
    }
  }

  async function leerRssMadrid() {
    const xmlData = await descargar(RSS_MADRID);
    if (!xmlData) {
      return [];
    }

    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlData, "text/xml");

      const items = doc.querySelectorAll("item");
      const enlaces = [];

      items.forEach(item => {
        const link = item.querySelector("link");
        if (link && link.textContent.trim().endsWith(".xml")) {
          enlaces.push(link.textContent.trim());
        }
      });

      return enlaces;
    } catch (error) {
      console.error("Error parseando RSS:", error);
      return [];
    }
  }


  function obtenerInfoEs(doc) {
    const infos = doc.querySelectorAll("info");

    for (const info of infos) {
      const lang = info.querySelector("language");
      if (lang && lang.textContent && lang.textContent.toLowerCase().startsWith("es")) {
        return info;
      }
    }

    return null;
  }

  function formatearAviso(infoEs) {
    function get(tag) {
      const el = infoEs.querySelector(tag);
      return el && el.textContent ? el.textContent.trim() : "";
    }

    const inicio = get("onset");
    const fin = get("expires");

    const zona = get("areaDesc");

    // Omitir avisos de "Sierra de Madrid"
    if (zona.toLowerCase().includes("sierra")) {
      return null;
    }

    try {
      const expiresDate = new Date(fin);
      if (expiresDate <= new Date()) {
        return null; // Si est치 caducado, no lo proceso
      }
    } catch (error) {
      return null;
    }

    return {
      event: get("event")
    };
  }

  async function procesarAviso(url) {
    const xmlData = await descargar(url);
    if (!xmlData) {
      return null;
    }

    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlData, "text/xml");

      const infoEs = obtenerInfoEs(doc);
      if (!infoEs) {
        return null;
      }

      const resultado = formatearAviso(infoEs);
      if (!resultado) {
        return null;
      }

      return resultado;
    } catch (error) {
      console.error("Error parseando CAP:", error);
      return null;
    }
  }

  async function obtenerAlertas() {
    const enlaces = await leerRssMadrid();
    const alertas = [];

    if (!enlaces || enlaces.length === 0) {
      //console.log("Consulta realizada: no hay alertas.");
      return [];
    }

    for (const url of enlaces) {
      const aviso = await procesarAviso(url);
      if (aviso) {
        alertas.push(aviso);
      }
    }

    // Deduplicar por evento
    const alertasUnicas = [];
    const vistos = new Set();

    for (const alerta of alertas) {
      const ev = alerta.event;
      if (!vistos.has(ev)) {
        vistos.add(ev);
        alertasUnicas.push(alerta);
      }
    }

    //console.log(`游댃 Obtenidas ${alertasUnicas.length} alerta(s)`);
    return alertasUnicas;
  }

  // -----------------------------
  // MOSTRAR ALERTAS EN LA P츼GINA
  // -----------------------------
  async function mostrarAlertas() {
    try {
      const alertas = await obtenerAlertas();

      if (alertas && alertas.length > 0) {
        const eventos = alertas.map(a => a.event).join(', ');

        const alertDiv = `
        <div style="
          background-color: #f9f9f9;
          border-left: 5px solid #e55353;
          color: #333;
          padding: 12px 16px;
          font-weight: 500;
          font-size: 1em;
          position: sticky;
          top: 10px;
          z-index: 9999;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          max-width: 90%;
          margin: 10px auto;
          line-height: 1.4;">
          <strong>AVISO AUTOMATIZADO DE FEN칍MENOS METEOROL칍GICOS ADVERSOS:</strong>
          ${eventos}
        </div>
      `;

        document.getElementById('alertas-container').innerHTML = alertDiv;
      }
    } catch (error) {
      console.error('Error al mostrar alertas:', error);
    }
  }

  // Ejecutar cuando cargue la p치gina
  mostrarAlertas();
</script>
<div id="futbol-alert"></div>
<script>
  async function checkFutbol() {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    const CF_CRITICAL_IPS = ["188.114.96.5", "188.114.97.5"];
    const div = document.getElementById("futbol-alert");

    try {
      const res = await fetch(
        "https://api.codetabs.com/v1/proxy?quest=https://hayahora.futbol/estado/data.json",
        { signal: controller.signal }
      );

      clearTimeout(timeoutId);
      if (!res.ok) return;

      const json = await res.json();
      if (!json?.data) return;

      const ipCounts = new Map();
      const criticalHits = new Set();

      json.data.forEach(entry => {
        if (!entry.stateChanges?.length) return;

        const last = entry.stateChanges.at(-1);

        if (last.state === true && entry.description === "Cloudflare") {
          const count = (ipCounts.get(entry.ip) || 0) + 1;
          ipCounts.set(entry.ip, count);

          if (CF_CRITICAL_IPS.includes(entry.ip)) {
            criticalHits.add(entry.ip);
          }
        }
      });

      // IPs con 3 o m치s bloqueos
      const repeatedBlockedIps = [...ipCounts.values()].filter(v => v > 2).length;

      // 쯘st치n bloqueadas las dos IPs cr칤ticas?
      const criticalPairBlocked =
        CF_CRITICAL_IPS.every(ip => criticalHits.has(ip));

      const hayBloqueos = repeatedBlockedIps > 3 || criticalPairBlocked;

      if (hayBloqueos) {
        div.innerHTML = `
        <strong>HAY BLOQUEOS ACTIVOS DE F칔TBOL:</strong> Gracias a los bloqueos indiscriminados de LaLiga algunas webs (incluida esta) pueden no funcionar con normalidad. Este aviso solo se muestra cuando hay bloqueos activos y confirmados en este momento. Informate de tus derechos al respecto. `;

        div.style.cssText = `
        background-color:#fff5f5;
        border-left:5px solid #e53e3e;
        color:#742a2a;
        padding:12px 16px;
        font-weight:500;
        font-size:1em;
        position:sticky;
        top:10px;
        z-index:9999;
        border-radius:4px;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        max-width:90%;
        margin:10px auto;
        line-height:1.4;
      `;
      } else {
        div.style.display = "none";
        div.innerHTML = "";
      }

    } catch (e) {
      clearTimeout(timeoutId);

      if (e.name === "AbortError" || e instanceof TypeError) {
        div.innerHTML = `
        <strong>T칔 CONEXI칍N A INTERNET PRESENTA IRREGULARIDADES:</strong> Tu conexi칩n a varios scripts (alojados en Cloudflare) en los que se sustenta esta web ha fallado, por lo que t칰 navegaci칩n no est치 operando con normalidad. Es muy probable que se trate de los bloqueos indiscriminados de LaLiga, pero no podemos asegurarlo. Recomendamos acceder a esta p치gina con una VPN, y ver si este aviso desaparece o cambia.`;

        div.style.cssText = `
        background-color:#fff5f5;
        border-left:5px solid #e53e3e;
        color:#742a2a;
        padding:12px 16px;
        font-weight:500;
        font-size:1em;
        position:sticky;
        top:10px;
        z-index:9999;
        border-radius:4px;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        max-width:90%;
        margin:10px auto;
        line-height:1.4;
      `;
      }
    }
  }


  checkFutbol();
  setInterval(checkFutbol, 120000);
</script>


<!--
<div id="navidades"
     style="
        background-color:#ebf8ff;
        border-left:5px solid #3182ce;
        color:#2a4365;
        padding:12px 16px;
        font-weight:500;
        font-size:1em;
        position:sticky;
        top:10px;
        z-index:9999;
        border-radius:4px;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        max-width:90%;
        margin:10px auto;
        line-height:1.4;
     ">
    <strong>ATENCI칍N:</strong>
    A consecuencia del periodo vacacional, las consultas realizadas al
    <strong>Equipo de Delegados</strong> podr칤an tardar m치s de lo habitual en ser contestadas.
    Felices Fiestas.
</div>

<div id="lluvia-alert"></div>
<script>

function ahoraEnEspana() {
    
    const formatter = new Intl.DateTimeFormat("es-ES", {
        timeZone: "Europe/Madrid",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric",
        hour12: false
    });

    const partes = formatter.formatToParts(new Date());
    const valores = Object.fromEntries(partes.map(p => [p.type, p.value]));

    return new Date(
        valores.year,
        valores.month - 1,
        valores.day,
        valores.hour,
        valores.minute,
        valores.second
    );
}

function mostrarAvisoLluvia() {
    const ahoraES = ahoraEnEspana();

    
    const fin = new Date(ahoraES);
    fin.setHours(11, 0, 0, 0);
    const div = document.getElementById("lluvia-alert");

    if (ahoraES < fin) {
        div.innerHTML = `
            <strong>ATENCI칍N:</strong> 
            Ante la previsi칩n de lluvias para hoy, se podr칤an registrar incidencias y retenciones en carretera. 
            Planifica en consecuencia, especialmente si vienes en coche, de cara al examen de EADP/AOP.
        `;

        div.style.cssText = `
            background-color:#ebf8ff;
            border-left:5px solid #3182ce;
            color:#2a4365;
            padding:12px 16px;
            font-weight:500;
            font-size:1em;
            position:sticky;
            top:10px;
            z-index:9999;
            border-radius:4px;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
            max-width:90%;
            margin:10px auto;
            line-height:1.4;
        `;
    } else {
        div.style.display = "none";
        div.innerHTML = "";
    }
}

// Ejecutar ya
mostrarAvisoLluvia();

setInterval(mostrarAvisoLluvia, 30000);
</script>



<div id="navidad-notice-modal" style="
    display:none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
    z-index: 9999;
">
  <div style="
        background:white;
        width: 80%;
        max-width: 350px;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        text-align:center;
    ">

    <h3>Aviso importante</h3>
    <p>
      A consecuencia del periodo vacacional, las consultas realizadas al
      <strong>Equipo de Delegados</strong> podr칤an tardar m치s de lo habitual en ser contestadas.
    </p>
    <p>Gracias por tu comprensi칩n y Felices Fiestas.</p>

    <button id="close-navidad-modal" style="
        margin-top: 10px;
        padding:8px 20px;
        border:none;
        background:#ccc;
        border-radius:5px;
        cursor:pointer;
    ">
      Cerrar
    </button>
  </div>
</div>

<script>
(function () {
    const modal = document.getElementById("navidad-notice-modal");
    const closeBtn = document.getElementById("close-navidad-modal");

    // Fecha l칤mite: 8 de enero a las 00:00
    const endDate = new Date("2026-01-08T00:00:00");
    const now = new Date();

    // Evitar mostrarlo m치s de una vez
    const shown = localStorage.getItem("navidadNoticeShown");

    if (now < endDate && !shown) {
        modal.style.display = "block";

        // Evento Google Analytics (GA4)
        if (typeof gtag === "function") {
            gtag('event', 'navidad_notice_view', {
                event_category: 'Avisos',
                event_label: 'Aviso periodo vacacional'
            });
        }
    }

    closeBtn.onclick = function () {
        localStorage.setItem("navidadNoticeShown", "true");
        modal.style.display = "none";
    };
})();
</script>
-->
<!-- BANNER DE TR츼FICO ANORMAL -->
<div id="banner-trafico-anormal" style="
    display:none;
    background-color:#ebf8ff;
    border-left:5px solid #3182ce;
    color:#2a4365;
    padding:12px 16px;
    font-weight:500;
    font-size:1em;
    position:sticky;
    top:10px;
    z-index:9999;
    border-radius:4px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    max-width:90%;
    margin:10px auto;
    line-height:1.4;
">
  <span id="banner-trafico-anormal-texto"></span>
</div>

<script>
  (async function () {
    const ENDPOINT = "https://notifierpushrss.onrender.com/api/m40";
    const banner = document.getElementById("banner-trafico-anormal");
    const texto = document.getElementById("banner-trafico-anormal-texto");


    try {
      const res = await fetch(ENDPOINT);
      if (!res.ok) throw new Error(`HTTP status ${res.status}`);

      const data = await res.json();

      if (!data || !data.trafico_anormal || !Array.isArray(data.trafico_anormal.registros)) {
        return;
      }

      const graves = data.trafico_anormal.registros;

      if (graves.length === 0) {
        banner.style.display = "none";
        return;
      }


      // Agrupar tramos por km_inicio-km_fin
      const tramosMap = new Map();

      graves.forEach(r => {
        const key = `km ${r.km_inicio}-${r.km_fin}`;
        if (!tramosMap.has(key)) {
          tramosMap.set(key, new Set());
        }
        tramosMap.get(key).add(r.sentido);
      });


      // Construir texto
      const tramosTexto = [];
      tramosMap.forEach((sentidos, tramo) => {
        let sentidoTexto = "ambos";
        if (sentidos.size === 1) {
          sentidoTexto = Array.from(sentidos)[0];
        }
        tramosTexto.push(`${tramo} (${sentidoTexto}, tr치fico ${graves[0].tipo_trafico})`);
      });


      texto.textContent = `Atasco en ${data.carretera}: ${tramosTexto.join(" 췅 ")}`;
      banner.style.display = "block";

    } catch (e) {
      console.error("Error al obtener datos de M40:", e);
      banner.style.display = "none";
    }
  })();
</script>