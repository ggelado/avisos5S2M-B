<div id="alertas-container"></div>
<script>

  const RSS_MADRID = "https://www.aemet.es/documentos_d/eltiempo/prediccion/avisos/rss/CAP_AFAC72_RSS.xml";
  const CORS_PROXY = "https://corsproxy.io/?url=";

  async function descargar(url) {
    try {
      const proxiedUrl = CORS_PROXY + encodeURIComponent(url);
      const response = await fetch(proxiedUrl);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.text();
    } catch (error) {
      console.error(`âŒ Error al descargar ${url}:`, error);
      return null;
    }
  }

  async function leerRssMadrid() {
    const xmlData = await descargar(RSS_MADRID);
    if (!xmlData) {
      return [];
    }

    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlData, "text/xml");

      const items = doc.querySelectorAll("item");
      const enlaces = [];

      items.forEach(item => {
        const link = item.querySelector("link");
        if (link && link.textContent.trim().endsWith(".xml")) {
          enlaces.push(link.textContent.trim());
        }
      });

      return enlaces;
    } catch (error) {
      console.error("Error parseando RSS:", error);
      return [];
    }
  }


  function obtenerInfoEs(doc) {
    const infos = doc.querySelectorAll("info");

    for (const info of infos) {
      const lang = info.querySelector("language");
      if (lang && lang.textContent && lang.textContent.toLowerCase().startsWith("es")) {
        return info;
      }
    }

    return null;
  }

  function formatearAviso(infoEs) {
    function get(tag) {
      const el = infoEs.querySelector(tag);
      return el && el.textContent ? el.textContent.trim() : "";
    }

    const inicio = get("onset");
    const fin = get("expires");

    const zona = get("areaDesc");

    // Omitir avisos de "Sierra de Madrid"
    if (zona.toLowerCase().includes("sierra")) {
      return null;
    }

    try {
      const expiresDate = new Date(fin);
      if (expiresDate <= new Date()) {
        return null; // Si estÃ¡ caducado, no lo proceso
      }
    } catch (error) {
      return null;
    }

    return {
      event: get("event")
    };
  }

  async function procesarAviso(url) {
    const xmlData = await descargar(url);
    if (!xmlData) {
      return null;
    }

    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlData, "text/xml");

      const infoEs = obtenerInfoEs(doc);
      if (!infoEs) {
        return null;
      }

      const resultado = formatearAviso(infoEs);
      if (!resultado) {
        return null;
      }

      return resultado;
    } catch (error) {
      console.error("Error parseando CAP:", error);
      return null;
    }
  }

  async function obtenerAlertas() {
    const enlaces = await leerRssMadrid();
    const alertas = [];

    if (!enlaces || enlaces.length === 0) {
      //console.log("Consulta realizada: no hay alertas.");
      return [];
    }

    for (const url of enlaces) {
      const aviso = await procesarAviso(url);
      if (aviso) {
        alertas.push(aviso);
      }
    }

    // Deduplicar por evento
    const alertasUnicas = [];
    const vistos = new Set();

    for (const alerta of alertas) {
      const ev = alerta.event;
      if (!vistos.has(ev)) {
        vistos.add(ev);
        alertasUnicas.push(alerta);
      }
    }

    //console.log(`ðŸ”„ Obtenidas ${alertasUnicas.length} alerta(s)`);
    return alertasUnicas;
  }

  // -----------------------------
  // MOSTRAR ALERTAS EN LA PÃGINA
  // -----------------------------
  async function mostrarAlertas() {
    try {
      const alertas = await obtenerAlertas();

      if (alertas && alertas.length > 0) {
        const eventos = alertas.map(a => a.event).join(', ');

        const alertDiv = `
        <div style="
          background-color: #f9f9f9;
          border-left: 5px solid #e55353;
          color: #333;
          padding: 12px 16px;
          font-weight: 500;
          font-size: 1em;
          position: sticky;
          top: 10px;
          z-index: 9999;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          max-width: 90%;
          margin: 10px auto;
          line-height: 1.4;">
          <strong>AVISO AUTOMATIZADO DE FENÃ“MENOS METEOROLÃ“GICOS ADVERSOS:</strong>
          ${eventos}
        </div>
      `;

        document.getElementById('alertas-container').innerHTML = alertDiv;
      }
    } catch (error) {
      console.error('Error al mostrar alertas:', error);
    }
  }

  // Ejecutar cuando cargue la pÃ¡gina
  mostrarAlertas();
</script>
<div id="futbol-alert"></div>
<script>
  async function checkFutbol() {
    try {
      const res = await fetch('https://corsproxy.io/?https://hayahora.futbol/estado/data.json');
      const data = await res.json();

      let count = 0;
      const ips = new Map();

      data.data.forEach(entry => {
        if (entry.stateChanges && entry.stateChanges.length > 0) {
          const last = entry.stateChanges[entry.stateChanges.length - 1];
          if (last.state === true && entry.description === "Cloudflare") {
            ips.set(entry.ip, (ips.get(entry.ip) || 0) + 1);
          }
        }
      });

      count = Array.from(ips.values()).filter(c => c > 2).length;
      const hayFutbol = count > 10;

      const div = document.getElementById('futbol-alert');

      if (hayFutbol) {
        div.innerHTML = '<strong>HAY BLOQUEOS DE FÃšTBOL:</strong> Gracias a los bloqueos indiscriminados de LaLiga algunas webs pueden no funcionar con normalidad. Este aviso solo se muestra cuando hay bloqueos activos y confirmados en este momento. Informate de tus derechos al respecto.';
        div.style.cssText = 'background-color:#fff5f5;border-left:5px solid #e53e3e;color:#742a2a;padding:12px 16px;font-weight:500;font-size:1em;position:sticky;top:10px;z-index:9999;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,0.1);max-width:90%;margin:10px auto;line-height:1.4;';
      } else {
        div.style.display = 'none';
        div.innerHTML = '';
      }
    } catch (e) {
      console.error('Error:', e);
    }
  }

  checkFutbol();
  setInterval(checkFutbol, 120000);
</script>
<!--
<div id="lluvia-alert"></div>
<script>

function ahoraEnEspana() {
    
    const formatter = new Intl.DateTimeFormat("es-ES", {
        timeZone: "Europe/Madrid",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric",
        hour12: false
    });

    const partes = formatter.formatToParts(new Date());
    const valores = Object.fromEntries(partes.map(p => [p.type, p.value]));

    return new Date(
        valores.year,
        valores.month - 1,
        valores.day,
        valores.hour,
        valores.minute,
        valores.second
    );
}

function mostrarAvisoLluvia() {
    const ahoraES = ahoraEnEspana();

    
    const fin = new Date(ahoraES);
    fin.setHours(11, 0, 0, 0);
    const div = document.getElementById("lluvia-alert");

    if (ahoraES < fin) {
        div.innerHTML = `
            <strong>ATENCIÃ“N:</strong> 
            Ante la previsiÃ³n de lluvias para hoy, se podrÃ­an registrar incidencias y retenciones en carretera. 
            Planifica en consecuencia, especialmente si vienes en coche, de cara al examen de EADP/AOP.
        `;

        div.style.cssText = `
            background-color:#ebf8ff;
            border-left:5px solid #3182ce;
            color:#2a4365;
            padding:12px 16px;
            font-weight:500;
            font-size:1em;
            position:sticky;
            top:10px;
            z-index:9999;
            border-radius:4px;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
            max-width:90%;
            margin:10px auto;
            line-height:1.4;
        `;
    } else {
        div.style.display = "none";
        div.innerHTML = "";
    }
}

// Ejecutar ya
mostrarAvisoLluvia();

setInterval(mostrarAvisoLluvia, 30000);
</script>
-->