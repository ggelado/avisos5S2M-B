{% if site.data.alerts and site.data.alerts.size > 0 %}
<div style="
    background-color: #f9f9f9;
    border-left: 5px solid #e55353;
    color: #333;
    padding: 12px 16px;
    font-weight: 500;
    font-size: 1em;
    position: sticky;
    top: 10px;
    z-index: 9999;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    max-width: 90%;
    margin: 10px auto;
    line-height: 1.4;">
   <strong>AVISO AUTOMATIZADO DE FENÓMENOS METEOROLÓGICOS ADVERSOS:</strong>
  {% for alerta in site.data.alerts %}
    {{ alerta.event }}{% unless forloop.last %}, {% endunless %}
  {% endfor %}
</div>
{% endif %}
<div id="futbol-alert"></div>
<script>
async function checkFutbol() {
    try {
        const res = await fetch('https://corsproxy.io/?https://hayahora.futbol/estado/data.json');
        const data = await res.json();

        let count = 0;
        const ips = new Map();
        
        data.data.forEach(entry => {
            if (entry.stateChanges && entry.stateChanges.length > 0) {
                const last = entry.stateChanges[entry.stateChanges.length - 1];
                if (last.state === true && entry.description === "Cloudflare") {
                    ips.set(entry.ip, (ips.get(entry.ip) || 0) + 1);
                }
            }
        });
        
        count = Array.from(ips.values()).filter(c => c > 2).length;
        const hayFutbol = count > 10;
        
        const div = document.getElementById('futbol-alert');
        
        if (hayFutbol) {
            div.innerHTML = '<strong>HAY BLOQUEOS DE FÚTBOL:</strong> Gracias a los bloqueos indiscriminados de LaLiga algunas webs pueden no funcionar con normalidad. Este aviso solo se muestra cuando hay bloqueos activos y confirmados en este momento.';
            div.style.cssText = 'background-color:#fff5f5;border-left:5px solid #e53e3e;color:#742a2a;padding:12px 16px;font-weight:500;font-size:1em;position:sticky;top:10px;z-index:9999;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,0.1);max-width:90%;margin:10px auto;line-height:1.4;';
        } else {
            div.style.display = 'none';
			div.innerHTML = '';
        }
    } catch(e) {
        console.error('Error:', e);
    }
}

checkFutbol();
setInterval(checkFutbol, 120000);
</script>

<div id="lluvia-alert"></div>
<script>

function ahoraEnEspana() {
    
    const formatter = new Intl.DateTimeFormat("es-ES", {
        timeZone: "Europe/Madrid",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric",
        hour12: false
    });

    const partes = formatter.formatToParts(new Date());
    const valores = Object.fromEntries(partes.map(p => [p.type, p.value]));

    return new Date(
        valores.year,
        valores.month - 1,
        valores.day,
        valores.hour,
        valores.minute,
        valores.second
    );
}

function mostrarAvisoLluvia() {
    const ahoraES = ahoraEnEspana();

    
    const fin = new Date(ahoraES);
    fin.setHours(11, 0, 0, 0);
    const div = document.getElementById("lluvia-alert");

    if (ahoraES < fin) {
        div.innerHTML = `
            <strong>ATENCIÓN:</strong> 
            Ante la previsión de lluvias para hoy, se podrían registrar incidencias y retenciones en carretera. 
            Planifica en consecuencia, especialmente si vienes en coche, de cara al examen de EADP/AOP.
        `;

        div.style.cssText = `
            background-color:#ebf8ff;
            border-left:5px solid #3182ce;
            color:#2a4365;
            padding:12px 16px;
            font-weight:500;
            font-size:1em;
            position:sticky;
            top:10px;
            z-index:9999;
            border-radius:4px;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
            max-width:90%;
            margin:10px auto;
            line-height:1.4;
        `;
    } else {
        div.style.display = "none";
        div.innerHTML = "";
    }
}

// Ejecutar ya
mostrarAvisoLluvia();

setInterval(mostrarAvisoLluvia, 30000);
</script>

